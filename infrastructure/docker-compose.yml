# FlowForge Infrastructure Layer - Production Docker Compose
# Version: 1.0.0
# Description: Production-ready infrastructure services for FlowForge

version: '3.8'

name: flowforge-infrastructure

services:
  # ===========================================
  # PostgreSQL Database
  # ===========================================
  postgres:
    image: postgres:15-alpine
    container_name: flowforge-postgres
    hostname: postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-flowforge}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      POSTGRES_DB: ${POSTGRES_DB:-flowforge_db}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./postgres/init:/docker-entrypoint-initdb.d:ro
      - ./postgres/conf/postgresql.conf:/etc/postgresql/postgresql.conf:ro
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    networks:
      - backend
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-flowforge} -d ${POSTGRES_DB:-flowforge_db}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.25'
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
        labels: "service,environment"
    labels:
      - "com.flowforge.service=postgres"
      - "com.flowforge.tier=infrastructure"

  # ===========================================
  # Redis Cache & Sessions
  # ===========================================
  redis:
    image: redis:7-alpine
    container_name: flowforge-redis
    hostname: redis
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD:?REDIS_PASSWORD is required}
      --maxmemory ${REDIS_MAXMEMORY:-512mb}
      --maxmemory-policy allkeys-lru
      --appendonly yes
      --appendfsync everysec
      --tcp-keepalive 300
      --timeout 0
      --tcp-backlog 511
      --loglevel notice
    volumes:
      - redis_data:/data
      - ./redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
    ports:
      - "${REDIS_PORT:-6379}:6379"
    networks:
      - backend
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.1'
    logging:
      driver: "json-file"
      options:
        max-size: "30m"
        max-file: "3"
        labels: "service,environment"
    labels:
      - "com.flowforge.service=redis"
      - "com.flowforge.tier=infrastructure"

  # ===========================================
  # Qdrant Vector Database
  # ===========================================
  qdrant:
    image: qdrant/qdrant:latest
    container_name: flowforge-qdrant
    hostname: qdrant
    environment:
      QDRANT__SERVICE__GRPC_PORT: 6334
      QDRANT__SERVICE__HTTP_PORT: 6333
      QDRANT__STORAGE__STORAGE_PATH: /qdrant/storage
      QDRANT__STORAGE__SNAPSHOTS_PATH: /qdrant/snapshots
      QDRANT__TELEMETRY_DISABLED: ${QDRANT_TELEMETRY_DISABLED:-true}
      QDRANT__LOG_LEVEL: ${QDRANT_LOG_LEVEL:-INFO}
    volumes:
      - qdrant_data:/qdrant/storage
      - qdrant_snapshots:/qdrant/snapshots
    ports:
      - "${QDRANT_HTTP_PORT:-6333}:6333"
      - "${QDRANT_GRPC_PORT:-6334}:6334"
    networks:
      - backend
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:6333/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2.0'
        reservations:
          memory: 512M
          cpus: '0.5'
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
        labels: "service,environment"
    labels:
      - "com.flowforge.service=qdrant"
      - "com.flowforge.tier=infrastructure"

  # ===========================================
  # Kong Gateway - Migrations
  # ===========================================
  kong-migrations:
    image: kong:3.9-alpine
    container_name: flowforge-kong-migrations
    hostname: kong-migrations
    command: kong migrations bootstrap
    environment:
      KONG_DATABASE: postgres
      KONG_PG_HOST: postgres
      KONG_PG_PORT: 5432
      KONG_PG_USER: ${KONG_PG_USER:-kong}
      KONG_PG_PASSWORD: ${KONG_PG_PASSWORD:?KONG_PG_PASSWORD is required}
      KONG_PG_DATABASE: ${KONG_PG_DATABASE:-kong_db}
      KONG_PASSWORD: ${KONG_ADMIN_PASSWORD:-}
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - backend
    restart: on-failure:5
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "2"
    labels:
      - "com.flowforge.service=kong-migrations"
      - "com.flowforge.tier=infrastructure"

  # ===========================================
  # Kong Gateway - Migration Up (for upgrades)
  # ===========================================
  kong-migrations-up:
    image: kong:3.9-alpine
    container_name: flowforge-kong-migrations-up
    hostname: kong-migrations-up
    command: kong migrations up && kong migrations finish
    environment:
      KONG_DATABASE: postgres
      KONG_PG_HOST: postgres
      KONG_PG_PORT: 5432
      KONG_PG_USER: ${KONG_PG_USER:-kong}
      KONG_PG_PASSWORD: ${KONG_PG_PASSWORD:?KONG_PG_PASSWORD is required}
      KONG_PG_DATABASE: ${KONG_PG_DATABASE:-kong_db}
    depends_on:
      kong-migrations:
        condition: service_completed_successfully
    networks:
      - backend
    restart: on-failure:3
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "2"
    labels:
      - "com.flowforge.service=kong-migrations-up"
      - "com.flowforge.tier=infrastructure"

  # ===========================================
  # Kong API Gateway
  # ===========================================
  kong:
    image: kong:3.9-alpine
    container_name: flowforge-kong
    hostname: kong
    user: "${KONG_USER:-kong}"
    environment:
      # Database Configuration
      KONG_DATABASE: postgres
      KONG_PG_HOST: postgres
      KONG_PG_PORT: 5432
      KONG_PG_USER: ${KONG_PG_USER:-kong}
      KONG_PG_PASSWORD: ${KONG_PG_PASSWORD:?KONG_PG_PASSWORD is required}
      KONG_PG_DATABASE: ${KONG_PG_DATABASE:-kong_db}
      KONG_PG_MAX_CONCURRENT_QUERIES: 10
      KONG_PG_SEMAPHORE_TIMEOUT: 60000
      
      # Listener Configuration
      KONG_PROXY_LISTEN: "0.0.0.0:8000 reuseport backlog=16384, 0.0.0.0:8443 http2 ssl reuseport backlog=16384"
      KONG_ADMIN_LISTEN: "0.0.0.0:8001 reuseport backlog=16384, 0.0.0.0:8444 http2 ssl reuseport backlog=16384"
      
      # Logging Configuration
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ERROR_LOG: /dev/stderr
      KONG_LOG_LEVEL: ${KONG_LOG_LEVEL:-notice}
      
      # SSL/TLS Configuration
      KONG_SSL_CERT: ${KONG_SSL_CERT:-}
      KONG_SSL_CERT_KEY: ${KONG_SSL_CERT_KEY:-}
      KONG_ADMIN_SSL_CERT: ${KONG_ADMIN_SSL_CERT:-}
      KONG_ADMIN_SSL_CERT_KEY: ${KONG_ADMIN_SSL_CERT_KEY:-}
      
      # Performance Configuration
      KONG_NGINX_WORKER_PROCESSES: ${KONG_NGINX_WORKER_PROCESSES:-auto}
      KONG_NGINX_HTTP_KEEPALIVE_TIMEOUT: 60s
      KONG_UPSTREAM_KEEPALIVE_POOL_SIZE: 100
      KONG_UPSTREAM_KEEPALIVE_MAX_REQUESTS: 1000
      KONG_UPSTREAM_KEEPALIVE_IDLE_TIMEOUT: 60
      
      # Security Configuration
      KONG_TRUSTED_IPS: "0.0.0.0/0,::/0"
      KONG_REAL_IP_HEADER: "X-Forwarded-For"
      KONG_REAL_IP_RECURSIVE: "on"
      
      # Declarative Config (optional - use with DB-less mode)
      # KONG_DECLARATIVE_CONFIG: /etc/kong/declarative/kong.yml
      
      # Admin GUI (Kong Manager - Enterprise feature)
      KONG_ADMIN_GUI_URL: ${KONG_ADMIN_GUI_URL:-http://localhost:8002}
      
      # Plugins
      KONG_PLUGINS: bundled
      
    volumes:
      - ../gateway/kong.yml:/etc/kong/declarative/kong.yml:ro
      - kong_prefix_vol:/var/run/kong
      - kong_tmp_vol:/tmp
      - ./certs:/etc/kong/certs:ro
    ports:
      - "${KONG_PROXY_PORT:-8000}:8000"        # HTTP Proxy
      - "${KONG_ADMIN_PORT:-8001}:8001"        # HTTP Admin API
      - "${KONG_PROXY_SSL_PORT:-8443}:8443"   # HTTPS Proxy
      - "${KONG_ADMIN_SSL_PORT:-8444}:8444"   # HTTPS Admin API
    networks:
      - backend
      - frontend
    depends_on:
      postgres:
        condition: service_healthy
      kong-migrations-up:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 60s
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    read_only: true
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '2.0'
        reservations:
          memory: 256M
          cpus: '0.5'
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"
        labels: "service,environment"
    labels:
      - "com.flowforge.service=kong"
      - "com.flowforge.tier=gateway"

# ===========================================
# Networks
# ===========================================
networks:
  backend:
    name: flowforge-backend
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.28.0.0/16
    driver_opts:
      com.docker.network.bridge.enable_icc: "true"
      com.docker.network.bridge.enable_ip_masquerade: "true"
    labels:
      - "com.flowforge.network=backend"

  frontend:
    name: flowforge-frontend
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.29.0.0/16
    driver_opts:
      com.docker.network.bridge.enable_icc: "true"
      com.docker.network.bridge.enable_ip_masquerade: "true"
    labels:
      - "com.flowforge.network=frontend"

# ===========================================
# Volumes
# ===========================================
volumes:
  postgres_data:
    name: flowforge-postgres-data
    driver: local
    labels:
      - "com.flowforge.volume=postgres-data"
      - "com.flowforge.backup=true"

  redis_data:
    name: flowforge-redis-data
    driver: local
    labels:
      - "com.flowforge.volume=redis-data"
      - "com.flowforge.backup=true"

  qdrant_data:
    name: flowforge-qdrant-data
    driver: local
    labels:
      - "com.flowforge.volume=qdrant-data"
      - "com.flowforge.backup=true"

  qdrant_snapshots:
    name: flowforge-qdrant-snapshots
    driver: local
    labels:
      - "com.flowforge.volume=qdrant-snapshots"
      - "com.flowforge.backup=true"

  kong_prefix_vol:
    name: flowforge-kong-prefix
    driver: local
    labels:
      - "com.flowforge.volume=kong-prefix"

  kong_tmp_vol:
    name: flowforge-kong-tmp
    driver: local
    labels:
      - "com.flowforge.volume=kong-tmp"
