# Development overrides for FlowForge
# Usage: docker-compose -f docker-compose.yml -f docker-compose.dev.yml up

version: '3.8'

services:
  # ===========================================
  # Microservices - Development Overrides
  # ===========================================

  crypto-service:
    build:
      context: ./services/crypto-service
      dockerfile: Dockerfile
      target: development
    environment:
      NODE_ENV: development
      LOG_LEVEL: debug
    volumes:
      - ./services/crypto-service/src:/app/src:ro
      - ./services/crypto-service/package.json:/app/package.json:ro
    ports:
      - "3001:3001"
      - "9229:9229"  # Node.js debugger
    command: npm run dev

  math-service:
    build:
      context: ./services/math-service
      dockerfile: Dockerfile
      target: development
    environment:
      ENVIRONMENT: development
      LOG_LEVEL: debug
    volumes:
      - ./services/math-service/src:/app/src:ro
      - ./services/math-service/requirements.txt:/app/requirements.txt:ro
    ports:
      - "3002:3002"
      - "5678:5678"  # Python debugger (debugpy)
    command: uvicorn src.main:app --host 0.0.0.0 --port 3002 --reload

  pdf-service:
    build:
      context: ./services/pdf-service
      dockerfile: Dockerfile
      target: development
    environment:
      NODE_ENV: development
      LOG_LEVEL: debug
    volumes:
      - ./services/pdf-service/src:/app/src:ro
      - ./services/pdf-service/package.json:/app/package.json:ro
    ports:
      - "3003:3003"
      - "9230:9229"  # Node.js debugger
    command: npm run dev

  ocr-service:
    build:
      context: ./services/ocr-service
      dockerfile: Dockerfile
      target: development
    environment:
      ENVIRONMENT: development
      LOG_LEVEL: debug
    volumes:
      - ./services/ocr-service/src:/app/src:ro
      - ./services/ocr-service/requirements.txt:/app/requirements.txt:ro
    ports:
      - "3004:3004"
      - "5679:5678"  # Python debugger
    command: uvicorn src.main:app --host 0.0.0.0 --port 3004 --reload

  image-service:
    build:
      context: ./services/image-service
      dockerfile: Dockerfile
      target: development
    environment:
      NODE_ENV: development
      LOG_LEVEL: debug
    volumes:
      - ./services/image-service/src:/app/src:ro
      - ./services/image-service/package.json:/app/package.json:ro
    ports:
      - "3005:3005"
      - "9231:9229"  # Node.js debugger
    command: npm run dev

  llm-service:
    build:
      context: ./services/llm-service
      dockerfile: Dockerfile
      target: development
    environment:
      ENVIRONMENT: development
      LOG_LEVEL: debug
    volumes:
      - ./services/llm-service/src:/app/src:ro
      - ./services/llm-service/requirements.txt:/app/requirements.txt:ro
    ports:
      - "3006:3006"
      - "5680:5678"  # Python debugger
    command: uvicorn src.main:app --host 0.0.0.0 --port 3006 --reload

  vector-service:
    build:
      context: ./services/vector-service
      dockerfile: Dockerfile
      target: development
    environment:
      ENVIRONMENT: development
      LOG_LEVEL: debug
    volumes:
      - ./services/vector-service/src:/app/src:ro
      - ./services/vector-service/requirements.txt:/app/requirements.txt:ro
    ports:
      - "3007:3007"
      - "5681:5678"  # Python debugger
    command: uvicorn src.main:app --host 0.0.0.0 --port 3007 --reload

  data-transform-service:
    build:
      context: ./services/data-transform-service
      dockerfile: Dockerfile
      target: development
    environment:
      NODE_ENV: development
      LOG_LEVEL: debug
    volumes:
      - ./services/data-transform-service/src:/app/src:ro
      - ./services/data-transform-service/package.json:/app/package.json:ro
    ports:
      - "3008:3008"
      - "9232:9229"  # Node.js debugger
    command: npm run dev

  # ===========================================
  # Web UI - Development Override
  # ===========================================

  web-ui:
    build:
      context: ./web-ui
      dockerfile: Dockerfile
      target: development
    environment:
      NODE_ENV: development
      VITE_API_URL: http://localhost:8000
    volumes:
      - ./web-ui/src:/app/src:ro
      - ./web-ui/public:/app/public:ro
      - ./web-ui/index.html:/app/index.html:ro
      - ./web-ui/vite.config.ts:/app/vite.config.ts:ro
      - ./web-ui/tailwind.config.js:/app/tailwind.config.js:ro
    ports:
      - "3000:3000"
      - "24678:24678"  # Vite HMR
    command: npm run dev -- --host 0.0.0.0

  # ===========================================
  # Development Tools
  # ===========================================

  # Adminer for database management
  adminer:
    image: adminer:latest
    container_name: flowforge-adminer
    ports:
      - "8080:8080"
    networks:
      - backend
    depends_on:
      - postgres

  # Redis Commander for Redis management
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: flowforge-redis-commander
    environment:
      REDIS_HOSTS: local:redis:6379:0:${REDIS_PASSWORD:-redis_password}
    ports:
      - "8081:8081"
    networks:
      - backend
    depends_on:
      - redis

networks:
  backend:
    driver: bridge
  frontend:
    driver: bridge
