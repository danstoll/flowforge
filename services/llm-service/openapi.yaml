openapi: 3.1.0
info:
  title: LLM Service API
  description: |
    A production-ready FastAPI wrapper around vLLM for on-premise LLM inference.
    
    ## Features
    - Text generation with streaming
    - Chat completion
    - Text classification
    - Entity extraction
    - Text summarization
    - Embeddings generation
    - **Vision OCR** - Intelligent text extraction from images
    - **Data Transform** - LLM-powered data transformation
    
    ## Authentication
    API key authentication via `X-API-Key` header (when enabled).
    
  version: 1.1.0
  contact:
    name: FlowForge Team
  license:
    name: MIT

servers:
  - url: http://localhost:8000
    description: Development server
  - url: https://api.flowforge.io/llm
    description: Production server

tags:
  - name: Generation
    description: Text generation endpoints
  - name: Chat
    description: Chat completion endpoints
  - name: Classification
    description: Text classification endpoints
  - name: Extraction
    description: Entity extraction endpoints
  - name: Summarization
    description: Text summarization endpoints
  - name: Embeddings
    description: Text embeddings endpoints
  - name: Vision
    description: Vision OCR and image understanding endpoints
  - name: Transform
    description: LLM-powered data transformation endpoints
  - name: Health
    description: Health check endpoints

paths:
  /api/v1/generate:
    post:
      tags: [Generation]
      summary: Generate text
      description: Generate text from a prompt with optional streaming.
      operationId: generateText
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GenerateRequest'
      responses:
        '200':
          description: Successful generation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenerateResponse'
            text/event-stream:
              schema:
                type: string
                description: Server-sent events stream
        '400':
          $ref: '#/components/responses/BadRequest'
        '503':
          $ref: '#/components/responses/ServiceUnavailable'

  /api/v1/chat:
    post:
      tags: [Chat]
      summary: Chat completion
      description: Generate a chat response from conversation history.
      operationId: chatCompletion
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatRequest'
      responses:
        '200':
          description: Successful chat completion
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatResponse'
            text/event-stream:
              schema:
                type: string
        '400':
          $ref: '#/components/responses/BadRequest'
        '503':
          $ref: '#/components/responses/ServiceUnavailable'

  /api/v1/classify:
    post:
      tags: [Classification]
      summary: Classify text
      description: Classify text into one of the provided categories.
      operationId: classifyText
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ClassifyRequest'
      responses:
        '200':
          description: Successful classification
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClassifyResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '503':
          $ref: '#/components/responses/ServiceUnavailable'

  /api/v1/extract-entities:
    post:
      tags: [Extraction]
      summary: Extract entities
      description: Extract named entities from text.
      operationId: extractEntities
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExtractEntitiesRequest'
      responses:
        '200':
          description: Successful extraction
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExtractEntitiesResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '503':
          $ref: '#/components/responses/ServiceUnavailable'

  /api/v1/summarize:
    post:
      tags: [Summarization]
      summary: Summarize text
      description: Generate a summary of the provided text.
      operationId: summarizeText
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SummarizeRequest'
      responses:
        '200':
          description: Successful summarization
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SummarizeResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '503':
          $ref: '#/components/responses/ServiceUnavailable'

  /api/v1/embeddings:
    post:
      tags: [Embeddings]
      summary: Generate embeddings
      description: Generate vector embeddings for text.
      operationId: generateEmbeddings
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EmbeddingsRequest'
      responses:
        '200':
          description: Successful embedding generation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EmbeddingsResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '503':
          $ref: '#/components/responses/ServiceUnavailable'

  /health:
    get:
      tags: [Health]
      summary: Health check
      description: Check the health status of the service.
      operationId: healthCheck
      responses:
        '200':
          description: Service health status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /health/live:
    get:
      tags: [Health]
      summary: Liveness probe
      description: Kubernetes liveness probe.
      operationId: livenessProbe
      responses:
        '200':
          description: Service is alive
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: alive

  /health/ready:
    get:
      tags: [Health]
      summary: Readiness probe
      description: Kubernetes readiness probe.
      operationId: readinessProbe
      responses:
        '200':
          description: Service is ready
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ready

  /models:
    get:
      tags: [Health]
      summary: List models
      description: List available models.
      operationId: listModels
      responses:
        '200':
          description: List of available models
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ModelsResponse'

  # Vision Endpoints
  /api/v1/vision/ocr:
    post:
      tags: [Vision]
      summary: Vision OCR
      description: |
        Extract text from images using vision-language models.
        Unlike traditional OCR, vision-based OCR understands context,
        handles handwriting, and can preserve layout.
      operationId: visionOCR
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VisionOCRRequest'
      responses:
        '200':
          description: Successful OCR
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VisionOCRResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '503':
          $ref: '#/components/responses/ServiceUnavailable'

  /api/v1/vision/describe:
    post:
      tags: [Vision]
      summary: Describe image
      description: Generate a natural language description of an image.
      operationId: visionDescribe
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VisionDescribeRequest'
      responses:
        '200':
          description: Successful description
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VisionDescribeResponse'
        '400':
          $ref: '#/components/responses/BadRequest'

  /api/v1/vision/extract:
    post:
      tags: [Vision]
      summary: Extract structured data from image
      description: Extract specific fields from documents, forms, receipts, invoices, etc.
      operationId: visionExtract
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VisionExtractRequest'
      responses:
        '200':
          description: Successful extraction
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VisionExtractResponse'
        '400':
          $ref: '#/components/responses/BadRequest'

  # Transform Endpoints
  /api/v1/transform:
    post:
      tags: [Transform]
      summary: Transform data
      description: |
        Transform data using natural language instructions.
        The LLM understands your intent and applies the transformation intelligently.
      operationId: transformData
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TransformRequest'
      responses:
        '200':
          description: Successful transformation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransformResponse'
        '400':
          $ref: '#/components/responses/BadRequest'

  /api/v1/transform/schema:
    post:
      tags: [Transform]
      summary: Transform to target schema
      description: Transform data to match a target JSON schema with intelligent field mapping.
      operationId: transformToSchema
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SchemaTransformRequest'
      responses:
        '200':
          description: Successful schema transformation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SchemaTransformResponse'
        '400':
          $ref: '#/components/responses/BadRequest'

  /api/v1/transform/convert:
    post:
      tags: [Transform]
      summary: Convert data format
      description: Convert data between formats (JSON, XML, YAML, CSV, etc.)
      operationId: convertFormat
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FormatConvertRequest'
      responses:
        '200':
          description: Successful conversion
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FormatConvertResponse'
        '400':
          $ref: '#/components/responses/BadRequest'

  /api/v1/transform/clean:
    post:
      tags: [Transform]
      summary: Clean and normalize data
      description: Clean and normalize data with operations like trim, deduplicate, standardize dates, etc.
      operationId: cleanData
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CleanDataRequest'
      responses:
        '200':
          description: Successful cleaning
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CleanDataResponse'
        '400':
          $ref: '#/components/responses/BadRequest'

  /api/v1/transform/merge:
    post:
      tags: [Transform]
      summary: Merge multiple data sources
      description: Intelligently merge multiple data sources with conflict resolution.
      operationId: mergeData
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MergeDataRequest'
      responses:
        '200':
          description: Successful merge
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MergeDataResponse'
        '400':
          $ref: '#/components/responses/BadRequest'

components:
  schemas:
    GenerateRequest:
      type: object
      required:
        - prompt
      properties:
        prompt:
          type: string
          description: The prompt to generate from
          minLength: 1
        max_tokens:
          type: integer
          description: Maximum tokens to generate
          default: 512
          minimum: 1
          maximum: 4096
        temperature:
          type: number
          description: Sampling temperature
          default: 0.7
          minimum: 0
          maximum: 2
        top_p:
          type: number
          description: Nucleus sampling parameter
          default: 1.0
          minimum: 0
          maximum: 1
        stop:
          type: array
          items:
            type: string
          description: Stop sequences
        model:
          type: string
          description: Model to use
        stream:
          type: boolean
          description: Whether to stream the response
          default: false

    GenerateResponse:
      type: object
      properties:
        success:
          type: boolean
          default: true
        text:
          type: string
          description: Generated text
        tokens_used:
          type: integer
          description: Total tokens used
        usage:
          $ref: '#/components/schemas/TokenUsage'
        model:
          type: string
          description: Model used
        finish_reason:
          type: string
          description: Reason for finishing

    ChatRequest:
      type: object
      required:
        - messages
      properties:
        messages:
          type: array
          items:
            $ref: '#/components/schemas/ChatMessage'
          minItems: 1
        max_tokens:
          type: integer
          default: 512
        temperature:
          type: number
          default: 0.7
        top_p:
          type: number
          default: 1.0
        model:
          type: string
        stream:
          type: boolean
          default: false

    ChatMessage:
      type: object
      required:
        - role
        - content
      properties:
        role:
          type: string
          enum: [system, user, assistant]
        content:
          type: string

    ChatResponse:
      type: object
      properties:
        success:
          type: boolean
          default: true
        message:
          type: object
          properties:
            role:
              type: string
              default: assistant
            content:
              type: string
        tokens_used:
          type: integer
        usage:
          $ref: '#/components/schemas/TokenUsage'
        model:
          type: string
        finish_reason:
          type: string

    ClassifyRequest:
      type: object
      required:
        - text
        - categories
      properties:
        text:
          type: string
          minLength: 1
        categories:
          type: array
          items:
            type: string
          minItems: 2
        model:
          type: string
        multi_label:
          type: boolean
          default: false

    ClassifyResponse:
      type: object
      properties:
        success:
          type: boolean
          default: true
        category:
          type: string
        confidence:
          type: number
          minimum: 0
          maximum: 1
        scores:
          type: array
          items:
            type: object
            properties:
              category:
                type: string
              confidence:
                type: number
        model:
          type: string

    ExtractEntitiesRequest:
      type: object
      required:
        - text
      properties:
        text:
          type: string
          minLength: 1
        entity_types:
          type: array
          items:
            type: string
        model:
          type: string

    ExtractEntitiesResponse:
      type: object
      properties:
        success:
          type: boolean
          default: true
        entities:
          type: array
          items:
            $ref: '#/components/schemas/Entity'
        text:
          type: string
        model:
          type: string

    Entity:
      type: object
      properties:
        text:
          type: string
        type:
          type: string
        start:
          type: integer
        end:
          type: integer
        confidence:
          type: number

    SummarizeRequest:
      type: object
      required:
        - text
      properties:
        text:
          type: string
          minLength: 10
        max_length:
          type: integer
          minimum: 10
          maximum: 1024
        min_length:
          type: integer
          minimum: 5
        style:
          type: string
          enum: [bullet, paragraph, tldr]
          default: paragraph
        model:
          type: string

    SummarizeResponse:
      type: object
      properties:
        success:
          type: boolean
          default: true
        summary:
          type: string
        original_length:
          type: integer
        summary_length:
          type: integer
        compression_ratio:
          type: number
        model:
          type: string

    EmbeddingsRequest:
      type: object
      required:
        - text
      properties:
        text:
          oneOf:
            - type: string
            - type: array
              items:
                type: string
        model:
          type: string
        normalize:
          type: boolean
          default: true

    EmbeddingsResponse:
      type: object
      properties:
        success:
          type: boolean
          default: true
        embeddings:
          type: array
          items:
            type: array
            items:
              type: number
        dimensions:
          type: integer
        model:
          type: string
        tokens_used:
          type: integer

    TokenUsage:
      type: object
      properties:
        prompt_tokens:
          type: integer
        completion_tokens:
          type: integer
        total_tokens:
          type: integer

    HealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
        timestamp:
          type: string
          format: date-time
        version:
          type: string
        uptime:
          type: number
        checks:
          type: object

    ModelsResponse:
      type: object
      properties:
        models:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              loaded:
                type: boolean
              capabilities:
                type: array
                items:
                  type: string
        default_model:
          type: string
        default_embedding_model:
          type: string

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          default: false
        error:
          type: string
        code:
          type: string
        details:
          type: object

    # Vision Schemas
    ImageInput:
      type: object
      properties:
        url:
          type: string
          description: URL to the image
        base64:
          type: string
          description: Base64-encoded image data
        media_type:
          type: string
          default: image/png

    VisionOCRRequest:
      type: object
      required:
        - image
      properties:
        image:
          $ref: '#/components/schemas/ImageInput'
        language_hints:
          type: array
          items:
            type: string
        output_format:
          type: string
          enum: [text, structured, markdown]
          default: text
        detail_level:
          type: string
          enum: [low, medium, high]
          default: medium
        preserve_layout:
          type: boolean
          default: false
        model:
          type: string

    VisionOCRResponse:
      type: object
      properties:
        success:
          type: boolean
        text:
          type: string
        regions:
          type: array
          items:
            type: object
            properties:
              text:
                type: string
              confidence:
                type: number
              bbox:
                type: array
                items:
                  type: integer
        confidence:
          type: number
        word_count:
          type: integer
        model:
          type: string
        processing_time_ms:
          type: integer

    VisionDescribeRequest:
      type: object
      required:
        - image
      properties:
        image:
          $ref: '#/components/schemas/ImageInput'
        prompt:
          type: string
        max_length:
          type: integer
          default: 200
        focus:
          type: string
          enum: [general, objects, text, people, scene]
          default: general
        model:
          type: string

    VisionDescribeResponse:
      type: object
      properties:
        success:
          type: boolean
        description:
          type: string
        objects_detected:
          type: array
          items:
            type: string
        text_detected:
          type: string
        model:
          type: string

    VisionExtractRequest:
      type: object
      required:
        - image
        - fields
      properties:
        image:
          $ref: '#/components/schemas/ImageInput'
        fields:
          type: array
          items:
            type: string
          minItems: 1
        document_type:
          type: string
        schema:
          type: object
        examples:
          type: array
          items:
            type: object
        model:
          type: string

    VisionExtractResponse:
      type: object
      properties:
        success:
          type: boolean
        fields:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              value: {}
              confidence:
                type: number
        raw_data:
          type: object
        document_type:
          type: string
        confidence:
          type: number
        model:
          type: string

    # Transform Schemas
    TransformRequest:
      type: object
      required:
        - data
        - instruction
      properties:
        data: {}
        instruction:
          type: string
          minLength: 5
        input_format:
          type: string
          enum: [json, xml, yaml, csv, markdown, text, html, sql]
        output_format:
          type: string
          enum: [json, xml, yaml, csv, markdown, text, html, sql]
          default: json
        examples:
          type: array
          items:
            type: object
            properties:
              input: {}
              output: {}
        model:
          type: string

    TransformResponse:
      type: object
      properties:
        success:
          type: boolean
        result: {}
        input_format:
          type: string
        output_format:
          type: string
        model:
          type: string

    SchemaTransformRequest:
      type: object
      required:
        - data
        - target_schema
      properties:
        data: {}
        source_schema:
          type: object
        target_schema:
          type: object
        mapping_hints:
          type: object
          additionalProperties:
            type: string
        fill_defaults:
          type: boolean
          default: true
        model:
          type: string

    SchemaTransformResponse:
      type: object
      properties:
        success:
          type: boolean
        result: {}
        mappings_used:
          type: object
        fields_filled:
          type: array
          items:
            type: string
        validation_passed:
          type: boolean
        model:
          type: string

    FormatConvertRequest:
      type: object
      required:
        - data
        - target_format
      properties:
        data:
          type: string
        source_format:
          type: string
          enum: [json, xml, yaml, csv, markdown, text, html, sql]
        target_format:
          type: string
          enum: [json, xml, yaml, csv, markdown, text, html, sql]
        infer_structure:
          type: boolean
          default: true
        model:
          type: string

    FormatConvertResponse:
      type: object
      properties:
        success:
          type: boolean
        result:
          type: string
        source_format:
          type: string
        target_format:
          type: string
        inferred_schema:
          type: object
        model:
          type: string

    CleanDataRequest:
      type: object
      required:
        - data
        - operations
      properties:
        data: {}
        operations:
          type: array
          items:
            type: string
            enum:
              - trim
              - normalize_whitespace
              - fix_encoding
              - standardize_dates
              - standardize_phones
              - standardize_addresses
              - deduplicate
              - fill_missing
              - fix_typos
              - normalize_case
          minItems: 1
        locale:
          type: string
          default: en-US
        model:
          type: string

    CleanDataResponse:
      type: object
      properties:
        success:
          type: boolean
        result: {}
        changes_made:
          type: array
          items:
            type: string
        records_removed:
          type: integer
        model:
          type: string

    MergeDataRequest:
      type: object
      required:
        - sources
      properties:
        sources:
          type: array
          items: {}
          minItems: 2
        merge_strategy:
          type: string
          enum: [union, intersection, left, smart]
          default: smart
        key_fields:
          type: array
          items:
            type: string
        conflict_resolution:
          type: string
          enum: [first, last, merge, ask]
          default: merge
        model:
          type: string

    MergeDataResponse:
      type: object
      properties:
        success:
          type: boolean
        result: {}
        sources_merged:
          type: integer
        conflicts_resolved:
          type: integer
        merge_report:
          type: string
        model:
          type: string

  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    
    ServiceUnavailable:
      description: Service unavailable
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
