# ===========================================
# FlowForge Example Plugins (ForgeHooks)
# ===========================================
# This file contains example plugins that can be started manually.
# In production, plugins are managed via the Plugin Manager UI.
#
# Usage (with core):
#   docker compose -f docker-compose.core.yml -f docker-compose.plugins.yml up -d
#
# Or start specific plugins:
#   docker compose -f docker-compose.core.yml -f docker-compose.plugins.yml up -d crypto-service
#
# NOTE: These are for development/testing. In production, use the
# Plugin Manager to install and manage ForgeHooks dynamically.
# ===========================================

version: '3.8'

name: flowforge

services:
  # ===========================================
  # Security ForgeHooks
  # ===========================================

  crypto-service:
    build:
      context: ./services/crypto-service
      dockerfile: Dockerfile
    container_name: flowforge-crypto-service
    labels:
      # ForgeHook labels for Plugin Manager discovery
      flowforge.forgehook: "true"
      flowforge.forgehook.id: "crypto-service"
      flowforge.forgehook.name: "Crypto Service"
      flowforge.forgehook.version: "1.0.0"
      flowforge.forgehook.category: "security"
    environment:
      NODE_ENV: production
      PORT: 4001
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-redis_password}
      LOG_LEVEL: ${LOG_LEVEL:-info}
    ports:
      - "4001:4001"
    networks:
      - flowforge-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    profiles:
      - plugins
      - security

  # ===========================================
  # Data Processing ForgeHooks
  # ===========================================

  math-service:
    build:
      context: ./services/math-service
      dockerfile: Dockerfile
    container_name: flowforge-math-service
    labels:
      flowforge.forgehook: "true"
      flowforge.forgehook.id: "math-service"
      flowforge.forgehook.name: "Math Service"
      flowforge.forgehook.version: "1.0.0"
      flowforge.forgehook.category: "data"
    environment:
      ENVIRONMENT: production
      PORT: 4002
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-redis_password}
      LOG_LEVEL: ${LOG_LEVEL:-info}
    ports:
      - "4002:4002"
    networks:
      - flowforge-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    profiles:
      - plugins
      - data

  pdf-service:
    build:
      context: ./services/pdf-service
      dockerfile: Dockerfile
    container_name: flowforge-pdf-service
    labels:
      flowforge.forgehook: "true"
      flowforge.forgehook.id: "pdf-service"
      flowforge.forgehook.name: "PDF Service"
      flowforge.forgehook.version: "1.0.0"
      flowforge.forgehook.category: "data"
    environment:
      NODE_ENV: production
      PORT: 4003
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-redis_password}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      PDF_MAX_SIZE_MB: ${PDF_MAX_SIZE_MB:-100}
    ports:
      - "4003:4003"
    networks:
      - flowforge-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    profiles:
      - plugins
      - data

  data-transform-service:
    build:
      context: ./services/data-transform-service
      dockerfile: Dockerfile
    container_name: flowforge-data-transform-service
    labels:
      flowforge.forgehook: "true"
      flowforge.forgehook.id: "data-transform-service"
      flowforge.forgehook.name: "Data Transform Service"
      flowforge.forgehook.version: "1.0.0"
      flowforge.forgehook.category: "data"
    environment:
      NODE_ENV: production
      PORT: 4008
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-redis_password}
      LOG_LEVEL: ${LOG_LEVEL:-info}
    ports:
      - "4008:4008"
    networks:
      - flowforge-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4008/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    profiles:
      - plugins
      - data

  # ===========================================
  # Media Processing ForgeHooks
  # ===========================================

  ocr-service:
    build:
      context: ./services/ocr-service
      dockerfile: Dockerfile
    container_name: flowforge-ocr-service
    labels:
      flowforge.forgehook: "true"
      flowforge.forgehook.id: "ocr-service"
      flowforge.forgehook.name: "OCR Service"
      flowforge.forgehook.version: "1.0.0"
      flowforge.forgehook.category: "media"
    environment:
      ENVIRONMENT: production
      PORT: 4004
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-redis_password}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      OCR_ENGINE: ${OCR_ENGINE:-paddleocr}
    ports:
      - "4004:4004"
    networks:
      - flowforge-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4004/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    profiles:
      - plugins
      - media

  image-service:
    build:
      context: ./services/image-service
      dockerfile: Dockerfile
    container_name: flowforge-image-service
    labels:
      flowforge.forgehook: "true"
      flowforge.forgehook.id: "image-service"
      flowforge.forgehook.name: "Image Service"
      flowforge.forgehook.version: "1.0.0"
      flowforge.forgehook.category: "media"
    environment:
      NODE_ENV: production
      PORT: 4005
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-redis_password}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      IMAGE_MAX_SIZE_MB: ${IMAGE_MAX_SIZE_MB:-50}
    ports:
      - "4005:4005"
    networks:
      - flowforge-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4005/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    profiles:
      - plugins
      - media

  # ===========================================
  # AI ForgeHooks
  # ===========================================

  llm-service:
    build:
      context: ./services/llm-service
      dockerfile: Dockerfile
    container_name: flowforge-llm-service
    labels:
      flowforge.forgehook: "true"
      flowforge.forgehook.id: "llm-service"
      flowforge.forgehook.name: "LLM Service"
      flowforge.forgehook.version: "1.0.0"
      flowforge.forgehook.category: "ai"
    environment:
      ENVIRONMENT: production
      PORT: 4006
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-redis_password}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      LLM_MODEL_PATH: /models
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      OPENAI_API_BASE: ${OPENAI_API_BASE:-}
    volumes:
      - llm_models:/models
    ports:
      - "4006:4006"
    networks:
      - flowforge-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4006/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    profiles:
      - plugins
      - ai

  vector-service:
    build:
      context: ./services/vector-service
      dockerfile: Dockerfile
    container_name: flowforge-vector-service
    labels:
      flowforge.forgehook: "true"
      flowforge.forgehook.id: "vector-service"
      flowforge.forgehook.name: "Vector Service"
      flowforge.forgehook.version: "1.0.0"
      flowforge.forgehook.category: "ai"
    environment:
      ENVIRONMENT: production
      PORT: 4007
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-redis_password}
      QDRANT_HOST: qdrant
      QDRANT_PORT: 6333
      LOG_LEVEL: ${LOG_LEVEL:-info}
    ports:
      - "4007:4007"
    networks:
      - flowforge-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4007/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    profiles:
      - plugins
      - ai

# ===========================================
# Networks (must reference external)
# ===========================================

networks:
  flowforge-network:
    external: true
    name: flowforge-network

# ===========================================
# Volumes
# ===========================================

volumes:
  llm_models:
    name: flowforge-llm-models
