_format_version: "3.0"
_transform: true

# ===========================================
# Services
# ===========================================

services:
  # Crypto Service
  - name: crypto-service
    url: http://crypto-service:3001
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    retries: 3
    routes:
      - name: crypto-routes
        paths:
          - /api/v1/crypto
        strip_path: false
        preserve_host: false
        protocols:
          - http
          - https

  # Math Service
  - name: math-service
    url: http://math-service:3002
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    retries: 3
    routes:
      - name: math-routes
        paths:
          - /api/v1/math
        strip_path: false
        preserve_host: false
        protocols:
          - http
          - https

  # PDF Service
  - name: pdf-service
    url: http://pdf-service:3003
    connect_timeout: 120000
    write_timeout: 120000
    read_timeout: 120000
    retries: 3
    routes:
      - name: pdf-routes
        paths:
          - /api/v1/pdf
        strip_path: false
        preserve_host: false
        protocols:
          - http
          - https

  # OCR Service
  - name: ocr-service
    url: http://ocr-service:3004
    connect_timeout: 120000
    write_timeout: 120000
    read_timeout: 120000
    retries: 3
    routes:
      - name: ocr-routes
        paths:
          - /api/v1/ocr
        strip_path: false
        preserve_host: false
        protocols:
          - http
          - https

  # Image Service
  - name: image-service
    url: http://image-service:3005
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    retries: 3
    routes:
      - name: image-routes
        paths:
          - /api/v1/image
        strip_path: false
        preserve_host: false
        protocols:
          - http
          - https

  # LLM Service
  - name: llm-service
    url: http://llm-service:3006
    connect_timeout: 300000
    write_timeout: 300000
    read_timeout: 300000
    retries: 2
    routes:
      - name: llm-routes
        paths:
          - /api/v1/llm
        strip_path: false
        preserve_host: false
        protocols:
          - http
          - https

  # Vector Service
  - name: vector-service
    url: http://vector-service:3007
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    retries: 3
    routes:
      - name: vector-routes
        paths:
          - /api/v1/vector
        strip_path: false
        preserve_host: false
        protocols:
          - http
          - https

  # Data Transform Service
  - name: data-transform-service
    url: http://data-transform-service:3008
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    retries: 3
    routes:
      - name: data-transform-routes
        paths:
          - /api/v1/data
        strip_path: false
        preserve_host: false
        protocols:
          - http
          - https

# ===========================================
# Global Plugins
# ===========================================

plugins:
  # CORS Plugin
  - name: cors
    config:
      origins:
        - "*"
      methods:
        - GET
        - POST
        - PUT
        - PATCH
        - DELETE
        - OPTIONS
      headers:
        - Accept
        - Accept-Version
        - Content-Length
        - Content-Type
        - Authorization
        - X-API-Key
        - X-Request-ID
      exposed_headers:
        - X-Request-ID
        - X-RateLimit-Limit
        - X-RateLimit-Remaining
        - X-RateLimit-Reset
      credentials: true
      max_age: 3600

  # Request ID Plugin
  - name: correlation-id
    config:
      header_name: X-Request-ID
      generator: uuid#counter
      echo_downstream: true

  # Request/Response Logging
  - name: file-log
    config:
      path: /dev/stdout
      reopen: true

  # Rate Limiting (Global)
  - name: rate-limiting
    config:
      minute: 100
      hour: 1000
      policy: local
      fault_tolerant: true
      hide_client_headers: false

  # Response Transformer (Add headers)
  - name: response-transformer
    config:
      add:
        headers:
          - "X-Powered-By:FlowForge"

# ===========================================
# Consumers (API Users)
# ===========================================

consumers:
  - username: default-user
    keyauth_credentials:
      - key: flowforge-default-api-key

# ===========================================
# Upstreams (for load balancing)
# ===========================================

upstreams:
  - name: crypto-service-upstream
    targets:
      - target: crypto-service:3001
        weight: 100
    healthchecks:
      active:
        healthy:
          interval: 30
          successes: 2
        unhealthy:
          interval: 10
          http_failures: 3
        http_path: /health
        timeout: 5

  - name: math-service-upstream
    targets:
      - target: math-service:3002
        weight: 100
    healthchecks:
      active:
        healthy:
          interval: 30
          successes: 2
        unhealthy:
          interval: 10
          http_failures: 3
        http_path: /health
        timeout: 5
